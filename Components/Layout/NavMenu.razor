@using Microsoft.AspNetCore.Identity
@using ZadaniaBlazor
@using ZadaniaBlazor.Components
@using ZadaniaBlazor.Components.Layout
@using ZadaniaBlazor.Data
@implements IDisposable
@inject NavigationManager NavigationManager
@rendermode InteractiveServer


@inject UserManager<ApplicationUser> UserManager
@inject AuthenticationStateProvider AuthStateProvider
@inject UserClaimsService UserClaimsService

<style>
    /* Usuwa podkreślenie, gdy link jest AKTYWNY (czyli gdy jesteśmy na tej stronie) */
    .nav-link.active,
    .nav-link.active:hover,
    .nav-link.active:focus {
        text-decoration: none !important;
        /* Tutaj możesz opcjonalnie dodać np. pogrubienie lub inny kolor,
           żeby użytkownik wiedział, gdzie jest, ale bez podkreślenia */
        background-color: rgba(255, 255, 255, 0.15) !important;
    }

    /* Styl dla całego linku, aby ikona i tekst były obok siebie */
    .user-menu-item {
        display: flex !important;
        align-items: flex-start !important; /* Ikona zostaje przy pierwszej linii tekstu */
        padding: 0.5rem 1rem !important;
    }

        /* Ikona - stała szerokość, żeby tekst jej nie spychał */
        .user-menu-item .bi {
            flex-shrink: 0;
            margin-right: 0.8rem;
            margin-top: 2px; /* Korekta wyrównania do pierwszej linii */
        }

    /* KLUCZOWY BLOK: Kontener na e-mail */
    .text-container {
        line-height: 1.1 !important; /* To likwiduje wielką przerwę między liniami */
        font-size: 0.85rem !important; /* Opcjonalnie: nieco mniejszy font dla maila lepiej wygląda */
        word-break: break-all !important; /* Wymusza złamanie maila w dowolnym miejscu */
        white-space: normal !important; /* Pozwala na zawijanie */
        display: block !important;
    }
</style>

<div class="top-row ps-3 navbar navbar-dark">
    <div class="container-fluid justify-content-center">
        <a class="navbar-brand text-center m-0" href="">
            <span class="bi bi-person-fill-nav-menu" aria-hidden="true"></span>
            <span class="fw-bold"> Użytkownik </span>
            @if (string.IsNullOrWhiteSpace(TokenTask))
            {
                <span class="status-dot dot-red"></span>
            }
            else
            {
                <span class="status-dot dot-green"></span>
            }
            <br />
            <AuthorizeView>
                <span class="small" style="font-size: 0.8rem;">@context.User.Identity?.Name</span><br />
            </AuthorizeView>
        </a>
    </div>
</div>

<input type="checkbox" title="Navigation menu" class="navbar-toggler" />

<div class="nav-scrollable" onclick="document.querySelector('.navbar-toggler').click()">
    <nav class="nav flex-column">
        <div class="nav-item px-3">
            <NavLink class="nav-link" href="" Match="NavLinkMatch.All">
                <span class="bi bi-house-door-fill-nav-menu" aria-hidden="true"></span>
                <div class="text-container">Start</div>
            </NavLink>
        </div>

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="weather">
                <span class="bi bi-list-nested-nav-menu" aria-hidden="true"></span>
                <div class="text-container">Pogoda</div>
            </NavLink>
        </div>

        @* -- Delikatna linia -- *@
        <hr class="text-white opacity-25 mx-3 my-2" />

        <div class="nav-item px-3">
            <NavLink class="nav-link" href="Zadania">
                <span class="bi bi-plus-square-fill-nav-menu" aria-hidden="true"></span>
                <div class="text-container">Zadania</div>
            </NavLink>
        </div>

        @* -- Delikatna linia -- *@
        <hr class="text-white opacity-25 mx-3 my-2" />

        <AuthorizeView>
            <Authorized>
                <div class="nav-item px-3">
                    <form action="Account/Logout" method="post">
                        <AntiforgeryToken />
                        <input type="hidden" name="ReturnUrl" value="@currentUrl" />
                        <button type="submit" class="nav-link" @onclick="BeforeLogout">
                            <span class="bi bi-arrow-bar-left-nav-menu" aria-hidden="true"></span>
                            <div class="text-container">Wylogowanie</div>
                        </button>
                    </form>
                </div>
            </Authorized>
            <NotAuthorized>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Register">
                        <span class="bi bi-person-nav-menu" aria-hidden="true"></span>
                        <div class="text-container">Rejestracja</div>
                    </NavLink>
                </div>
                <div class="nav-item px-3">
                    <NavLink class="nav-link" href="Account/Login">
                        <span class="bi bi-person-badge-nav-menu" aria-hidden="true"></span>
                        <div class="text-container">Logowanie</div>
                    </NavLink>
                </div>
            </NotAuthorized>
        </AuthorizeView>
    </nav>
</div>

@code {
    private string? currentUrl;
    private string? TokenTask { get; set; }

    protected override async Task OnInitializedAsync()
    {
        currentUrl = NavigationManager.ToBaseRelativePath(NavigationManager.Uri);
        NavigationManager.LocationChanged += OnLocationChanged;

        //
        var token = await UserClaimsService.GetClaimValueAsync(Const.TokenTask);
        if (TokenTask != token)
        {
            TokenTask = token;
            StateHasChanged();
        }
    }

    private void OnLocationChanged(object? sender, LocationChangedEventArgs e)
    {
        currentUrl = NavigationManager.ToBaseRelativePath(e.Location);
        StateHasChanged();
    }

    private async Task BeforeLogout()
    {
        await UserClaimsService.RemoveClaimAsync(Const.TokenTask);
    }

    public void Dispose()
    {
        NavigationManager.LocationChanged -= OnLocationChanged;
    }

}


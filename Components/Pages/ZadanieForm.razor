@page "/zadanie/dodaj"
@page "/zadanie/edycja/{Id:int}"
@rendermode InteractiveServer

@using ZadaniaBlazor
@using ZadaniaBlazor.Components
@using ZadaniaBlazor.Components.Layout
@using ZadaniaBlazor.Data

@inject ZadaniaService ZadaniaService
@inject NavigationManager Nav
@inject UserClaimsService UserClaimsService

<div class="container mt-4">
    <div class="card shadow">
        <div class="card-header bg-primary text-white">
            <h4>@(Id == 0 ? "🆕 Dodaj nowe zadanie" : "✏️ Edytuj zadanie")</h4>
        </div>
        <div class="card-body">
            <EditForm Model="model" OnValidSubmit="Zapisz">
                <div class="mb-3">
                    <label class="form-label">Tytuł zadania</label>
                    <input type="text" class="form-control" @bind-value="model.Tytul" placeholder="Co jest do zrobienia?" required />
                </div>
                <div class="mb-3">
                    <label class="form-label">Status</label>
                    <select class="form-select" @bind="model.Status" required>
                        <option value="" disabled selected>Wybierz status...</option>
                        <option value="Nowy">Nowy</option>
                        <option value="W realizacji">W realizacji</option>
                        <option value="Zatrzymany">Zatrzymany</option>
                        <option value="Zakończony">Zakończony</option>
                    </select>
                </div>
                <div class="mb-3">
                    <label class="form-label">Opis zadania</label>
                    <textarea class="form-control"
                              @bind="model.Tresc"
                              placeholder="Opis zadania, realizacji"
                              rows="4"
                              required></textarea>
                </div>                
                <div class="mb-3 form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="statusSwitch" @bind-value="model.CzyWykonane">
                    <label class="form-check-label" for="statusSwitch">Zadanie wykonane</label>
                </div>

                <div class="d-flex justify-content-between">
                    <button type="button" class="btn btn-secondary" @onclick="Powrot">Anuluj</button>
                    <button type="submit" class="btn btn-success">Zapisz zadanie</button>
                </div>
            </EditForm>
        </div>
    </div>
</div>

@code {
    [Parameter] public int Id { get; set; }
    private Zadanie model = new() { DataUtworzenia = DateTime.Now };
    private string? tokenTask = "";

    protected override async Task OnInitializedAsync()
    {
        tokenTask = await UserClaimsService.GetClaimValueAsync(Const.TokenTask);
        if (Id != 0 && !string.IsNullOrWhiteSpace(tokenTask)) 
        {
            var zadania = await ZadaniaService.PobierzZadania(tokenTask);
            var doEdycji = zadania.FirstOrDefault(z => z.Id == Id);
            if (doEdycji != null) model = doEdycji;
        }
    }

    private async Task Zapisz()
    {
        if (!string.IsNullOrWhiteSpace(tokenTask))
        {
           bool czyNowe = Id == 0;
           var sukces = await ZadaniaService.ZapiszZadanie(model, tokenTask, czyNowe);
           if (sukces) Nav.NavigateTo("/Zadania");
        }
    }

    private void Powrot() => Nav.NavigateTo("/Zadania");
}